<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏</title>
    <!-- Three.js -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>
    <style>
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      #preview-container {
        width: 300px;
        height: 200px;
        border: 2px solid #ccc;
        margin: 1rem 0;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      button {
        padding: 10px 20px;
        cursor: pointer;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <h1>–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—É—é 3D –º–æ–¥–µ–ª—å</h1>
    
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      
      <div class="form-group">
        {{ form.as_p }}
        
        <!-- 4. –°–µ—Ä—ã–π –∫–≤–∞–¥—Ä–∞—Ç –¥–ª—è –ø—Ä–µ–≤—å—é -->
        <div id="preview-container">–í—ã–±–µ—Ä–∏—Ç–µ .glb —Ñ–∞–π–ª</div>
        
        <!-- 2. –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è Base64 –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
        <input type="hidden" id="id_image_data" name="image_data">
        
        <!-- 2. –ö–Ω–æ–ø–∫–∞ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ -->
        <button type="submit" id="submit-btn" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É</button>
      </div>
    </form>
    
    <!-- JavaScript –¥–ª—è –ø—Ä–µ–≤—å—é -->
    <script type="module">
      import * as THREE from 'three';
      import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
      
      console.log('üî• Three.js —Å—Ç–∞—Ä—Ç');
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è Django —Ñ–æ—Ä–º—ã
      const fileInput = document.querySelector('input[name="file"]') || document.querySelector('#id_file');
      const previewContainer = document.getElementById('preview-container');
      const hiddenInput = document.getElementById('id_image_data');
      const submitBtn = document.getElementById('submit-btn');
      
      console.log('–≠–ª–µ–º–µ–Ω—Ç—ã:', { fileInput, previewContainer, hiddenInput, submitBtn });
      
      if (fileInput) {
        fileInput.addEventListener('change', function(e) {
          console.log('üìÅ –§–∞–π–ª –≤—ã–±—Ä–∞–Ω!');
          const file = e.target.files[0];
          if (file && file.name.toLowerCase().endsWith('.glb')) {
            previewContainer.innerHTML = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
            const url = URL.createObjectURL(file);
            generateThumbnail(url);
          } else {
            previewContainer.innerHTML = '–¢–æ–ª—å–∫–æ .glb —Ñ–∞–π–ª—ã!';
          }
        });
      }
      
      function generateThumbnail(modelUrl) {
        console.log('üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é');
        
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);
        
        const camera = new THREE.PerspectiveCamera(45, 300/200, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({ 
          antialias: true, 
          preserveDrawingBuffer: true 
        });
        renderer.setSize(300, 200);
        
        previewContainer.innerHTML = '';
        previewContainer.style.position = 'relative';
        previewContainer.appendChild(renderer.domElement);
        
        // –°–≤–µ—Ç
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);
        
        const loader = new GLTFLoader();
        loader.load(modelUrl, 
          (gltf) => {
            console.log('‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
            const model = gltf.scene;
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            model.position.sub(center);
            
            scene.add(model);
            camera.position.z = 5;
            camera.lookAt(0, 0, 0);
            
            renderer.render(scene, camera);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
            hiddenInput.value = renderer.domElement.toDataURL('image/jpeg', 0.8);
            submitBtn.disabled = false;
            submitBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É ‚úÖ';
            
            console.log('üéâ –ü—Ä–µ–≤—å—é –≥–æ—Ç–æ–≤–æ!');
          },
          undefined,
          (error) => {
            console.error('‚ùå –û—à–∏–±–∫–∞ GLB:', error);
            previewContainer.innerHTML = '–û—à–∏–±–∫–∞ GLB —Ñ–∞–π–ª–∞';
          }
        );
      }
    </script>
    
    <br />
    <a href="{% url 'home' %}">‚Üê –ù–∞–∑–∞–¥ –≤ –≥–∞–ª–µ—Ä–µ—é</a>
  </body>
</html>
